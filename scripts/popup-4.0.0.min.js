class LaraPush{currentDateTime=Math.floor(new Date().getTime()/1e3);constructor(e,t){this.options=e,this.data=t,this.writeInLog("options",{options:e}),this.writeInLog("data",{data:t}),this.init()}writeInLog(...e){window.larapushLogger&&console.log("LaraPush Log ::",...e)}async waitForXSeconds(e){return new Promise(t=>{setTimeout(()=>{t()},1e3*e)}).catch(()=>{this.writeInLog("Error in waitForXSeconds")})}registerServiceWorker=async()=>{if("serviceWorker"in navigator)try{try{var e;for(e of(await navigator.serviceWorker.getRegistrations())){var t=e.active.scriptURL;(t.includes("OneSignalSDKWorker.js")||t.includes("sw2.php")||t.includes("firebase-messaging-sw.js")||t.includes("sw.enot.js")||t.includes("service-worker-loader.js.php"))&&(await e.unregister()?console.log("Service Worker: Unregistered "+t+" successfully."):console.log("Service Worker: Unregistration of "+t+" failed."))}}catch(a){console.error("Error:",a)}var i=await navigator.serviceWorker.register(location.origin+"/push-sw.js",{scope:location.origin});return i.installing?console.log("Service worker installing"):i.waiting?console.log("Service worker installed"):i.active&&console.log("Service worker active"),i}catch(r){console.error("Registration failed with "+r)}};async initRegistration(){if("granted"==await this.getPermission()&&null!=localStorage.getItem("notification_token"))this.writeInLog("Token is already with larapush");else{await Notification.requestPermission();var e=await this.registerServiceWorker();this.writeInLog("sw",e);let t=!1;for(;!t;)await this.waitForXSeconds(.1),t=e.active;let a="";a=document.querySelector("#larapush-custom-segment")?document.querySelector("#larapush-custom-segment").value:window.location.href,e.active.postMessage({command:"amp-web-push-subscribe",url:a})}}async getPermission(){var e=(await navigator.serviceWorker.getRegistrations()).filter(e=>e.scope==location.origin);let t=await Notification.permission;return"granted"==t?0<e.length?"granted":"granted_default":"default"==t?"default":"denied"}async setNotificationPermissionChangeListener(){"permissions"in navigator&&navigator.permissions.query({name:"notifications"}).then(e=>{e.onchange=()=>{let t=e.state;"prompt"==e.state&&(t="default"),this.notificationPermissionChangeHandler(t)}})}async notificationPermissionChangeHandler(e){this.writeInLog("Notification Permission Changed",e),this.popup("hide"),"enable"==this.data.lockPageContent&&"granted"!=e||this.backdrop("hide"),this.updateBottomButtonContent(e),this.updateBackdropContent(e),"granted"==e&&this.initRegistration(),"granted_default"==e&&navigator.serviceWorker.getRegistrations().then(e=>{for(var t of(this.writeInLog("Unsubscribed"),e))t.unregister(),this.writeInLog("registration state","unregistered"),this.writeInLog("registration unregistered",t)})}isMobile(){return window.innerWidth<=480}isDesktop(){return!this.isMobile()}isCustomPopupIsEnabled(){return!!(this.isMobile()&&"enable"==this.data.mobile||this.isDesktop()&&"enable"==this.data.desktop)}isPageLockEnabled(){return"enable"==this.data.lockPageContent}async requestPermission(){this.popup("hide"),!this.isPageLockEnabled()&&this.isCustomPopupIsEnabled()||this.backdrop("show"),this.isCustomPopupIsEnabled()||await this.waitForXSeconds(1),Notification.requestPermission().then(()=>{"enable"!=this.data.lockPageContent&&this.backdrop("hide")})}async showPopupAndRequestPermission(){let e=async()=>{"default"==await this.getPermission()?this.isCustomPopupIsEnabled()?this.isPageLockEnabled()?this.backdrop("show"):(null==await this.readData("notification_rejected")||this.currentDateTime-parseInt(await this.readData("notification_rejected"))>parseInt(this.data.reappear))&&(await this.waitForXSeconds(this.data.delay),"enable"==this.data.backdrop&&this.backdrop("show"),this.popup("show")):(await this.waitForXSeconds(this.data.delay),this.requestPermission()):"granted"==await this.getPermission()?this.initRegistration():"denied"==await this.getPermission()?"enable"==this.data.lockPageContent?this.backdrop("show"):this.writeInLog("Notifications are blocked"):"granted_default"==await this.getPermission()&&this.writeInLog("Notifications permissions granted denied manually")};"complete"===document.readyState?await e():document.onreadystatechange=async()=>{"complete"===document.readyState&&await e()}}async loadBottomButtonAndPoweredBy(){}async updateBottomButtonContent(e){}async updateBackdropContent(e){}async bottomButtonSidebox(e=""){}async bottomButtonTopbox(e=null,t=""){}async bottomButton(e=null){}getReferralUrl(){}async backdrop(e=null){}async popup(e=null){}openDatabase=()=>new Promise((e,t)=>{var a=indexedDB.open("autopushDataBase",1);a.onupgradeneeded=e=>{e.target.result.createObjectStore("myObjectStore",{keyPath:"id"})},a.onsuccess=t=>{e(t.target.result)},a.onerror=e=>{t(e.target.error)}});writeData=async(e,t)=>{let a=(await this.openDatabase()).transaction("myObjectStore","readwrite");return a.objectStore("myObjectStore").put({id:e,data:t}),new Promise((e,t)=>{a.oncomplete=()=>{e()},a.onerror=()=>{t(a.error)}})};readData=async e=>{let t=(await this.openDatabase()).transaction("myObjectStore","readonly").objectStore("myObjectStore").get(e);return new Promise((e,a)=>{t.onsuccess=()=>{e(t.result?t.result.data:null)},t.onerror=()=>{a(t.error)}})};async init(){if(!window.LaraPushLoaded){window.LaraPushLoaded=!0,await this.registerServiceWorker();let e=setInterval(async()=>{if(null!=document.body){clearInterval(e);try{this.loadBottomButtonAndPoweredBy(),this.setNotificationPermissionChangeListener(),(null==await this.readData("notification_rejected")||this.currentDateTime-parseInt(await this.readData("notification_rejected"))>parseInt(this.data.reappear))&&this.showPopupAndRequestPermission()}catch(t){console.log(t)}}},100)}}}let larapushInterval=setInterval(()=>{"function"==typeof LoadLaraPush&&(LoadLaraPush(),clearInterval(larapushInterval)),window.LaraPushLoaded&&clearInterval(larapushInterval)},500);function LoadLaraPush(){console.error("LaraPush is not defined or not a function")}LoadLaraPush();
